{% extends 'base/jumbotron.html' %}

{% load quiz %}

{% block jumbotron %}
<div>
  <div id="quiz-char" class="quiz-char"></div>
</div>
{% endblock %}

{% block content %}
<div id="answers" class="row"></div>

<form class="row" id="quiz-form">
  <div class="form-group">
    <label for="answer">Romaji:</label>
    <input id="answer" name="answer" class="form-control" type="text" autofocus />
  </div>
  <div class="form-group">
    <input type="hidden" id="correct-answer" name="correct-answer" />
    <button class="btn btn-primary" onclick="check_answer(); return false;">Submit</button>
  </div>
</form>
{% endblock %}

{% block contentjs %}
{% render_as_quiz chars kana %}
<script type="application/javascript">

  // arrays of right and wrong answers
  var right = [], wrong = [];

  // get random char
  function rand_char() {
{#    console.log("pre-selection chars.length = " + chars.length);#}
    var index = Math.floor(Math.random()*chars.length),
        char = chars[index];
    chars.splice(index, 1);
{#    console.log("post-selection chars.length = " + chars.length);#}
    return char;
  }

  // render char object as form
  function render_char(char) {
{#    console.log("quiz char: " + char.char);#}
{#    console.log("answer: " + char.answer);#}
    $('#quiz-char').text(char.char);
    $('#correct-answer').val(char.answer);
  }

  // render results
  function render_results() {
    $('#jumbotron').hide();
    var form = $('#quiz-form');
    form.html('');
    form.html(
        "<p>barf</p>"
    );
  }

  // check answer
  function check_answer() {
    var user_answer = $('#answer'),
        user_answer_val = user_answer.val().toLowerCase(),
        correct_answer = $('#correct-answer').val(),
        char = $('#quiz-char').text();

    user_answer.val('');
{#    console.log("char: " + char);#}
{#    console.log("correct answer: " + correct_answer);#}
{#    console.log("user answered: " + user_answer_val);#}

    var answers = $('#answers'),
        answers_html = answers.html();
    if (answers_html == undefined) { answers_html = ''; }
    if (user_answer_val == correct_answer) {
      right.push(char);
      answers_html += '<span class="correct-answer">' + char + '</span>&nbsp;';
      answers.html(answers_html);
    } else {
      wrong.push(char);
      answers_html += '<span class="incorrect-answer">' + char + '</span>&nbsp;';
      answers.html(answers_html);
    }
    try {
      var new_char = rand_char();
      render_char(new_char);
    } catch (err) {
      console.log(err);
      if (err.message == "Cannot read property 'char' of undefined") {
        render_results();
      }
    }
{#    console.log("right: " + right);#}
{#    console.log("wrong: " + wrong);#}
  }

  // when ready, grab a char and render it
  $(document).ready(function() {
    var char = rand_char();
    render_char(char);
  });
</script>
{% endblock %}
